machine:
  services:
    - docker
  environment:
    PKG: ${CIRCLE_PROJECT_REPONAME}

dependencies:
  pre:
    - docker pull segment/golang:latest
  override:
    - docker run -i -t -v ${HOME}/.ssh:/root/.ssh:ro -v ${PWD}:/go/src/${PKG} -w /go/src/${PKG} segment/golang:latest get

test:
  override:
    - >
      docker run -i -t -v ${PWD}:/go/src/${PKG} -w /go/src/${PKG}
      -v /var/run/docker.sock:/var/run/docker.sock
      -v $(which docker):/usr/bin/docker:ro
      -v $(which docker-compose):/usr/bin/docker-compose:ro
      segment/golang:latest vet lint test benchmark
  post:
    - docker run -i -t -v ${PWD}:/go/src/${PKG} -w /go/src/${PKG} segment/golang:latest build
